#!/bin/bash
set -eu
source /var/vcap/jobs/targets/helpers/utils targets etcd-tls
export LANG=en_US.UTF-8
export PATH=$PATH:/var/vcap/packages/etcd/bin/


case $1 in
  start)
    echo "[$(date)] $TARGET phalanx target starting up (pid $$)..."
    pid_guard $PIDFILE $TARGET
    echo $$ > $PIDFILE

    if ! (openssl x509 -noout -in /var/vcap/packages/etcd/bin/ca.pem   && \
      openssl x509 -noout -in /var/vcap/packages/etcd/bin/cert.pem && \
      openssl rsa  -noout -in /var/vcap/packages/etcd/bin/key.pem); then
      mkdir -p /var/vcap/packages/etcd/bin/
      /var/vcap/packages/certifier/bin/certify /var/vcap/packages/etcd/bin/
    fi

    echo "ETCD with tls starting..."
    exec chpst -u vcap:vcap etcd --data-dir=/var/vcap/store/targets/etcd-tls/ \
      --name=etcd-tls \
      --listen-client-urls=https://0.0.0.0:2479 \
      --advertise-client-urls=https://0.0.0.0:2479 \
      --initial-advertise-peer-urls=https://127.0.0.1:2480 \
      --listen-peer-urls=https://127.0.0.1:2480 \
      --initial-cluster=etcd-tls=https://127.0.0.1:2480 \
      --peer-client-cert-auth=true \
      --peer-trusted-ca-file=/var/vcap/packages/etcd/bin/ca.pem \
      --peer-cert-file=/var/vcap/packages/etcd/bin/cert.pem \
      --peer-key-file=/var/vcap/packages/etcd/bin/key.pem \
      --client-cert-auth=true \
      --trusted-ca-file=/var/vcap/packages/etcd/bin/ca.pem \
      --cert-file=/var/vcap/packages/etcd/bin/cert.pem \
      --key-file=/var/vcap/packages/etcd/bin/key.pem
    ;;
  stop)
    echo "[$(date)] $TARGET phalanx target shutting down..."
    kill_and_wait $PIDFILE
    echo "[$(date)] $TARGET phalanx target shut down."
    ;;

  *)
    echo "Usage: $TARGET {start|stop}"
    ;;

esac
exit 0